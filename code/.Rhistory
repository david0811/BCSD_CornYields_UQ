usda <- read.csv('../data/usda/maize_county_yield_area.csv')
View(usda)
# Load yield data
usda <- read.csv('../data/usda/maize_county_yield_area.csv')
usda <- subset(usda, select=c('fips','year','lat','lon','log_yield', 'state'))
View(usda)
# Merge
df = merge(gmfd, usda)
# Fit model using felm
mod <- felm(log_yield ~ gdd + egdd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
library(lfe)
# Fit model using felm
mod <- felm(log_yield ~ gdd + egdd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
View(usda)
# Load yield data
usda <- read.csv('../data/usda/maize_county_yield_area.csv')
usda <- subset(usda, select=c('fips','year','lat','lon','log_yield', 'state'))
usda <- filter(usda, lon <= -100) # Select east of 100W meridian
library(dplyr)
usda <- filter(usda, lon <= -100) # Select east of 100W meridian
View(usda)
# Load yield data
usda <- read.csv('../data/usda/maize_county_yield_area.csv')
usda <- subset(usda, select=c('fips','year','lat','lon','log_yield', 'state'))
usda <- filter(usda, lon >= -100) # Select east of 100W meridian
# Merge
df = merge(gmfd, usda)
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
View(df)
df <- filter(df, year <= 2005) # Select east of 100W meridian
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
setwd("~/Projects/UIUC/ClimagAll/econometrics_textbook/weather-panel.github.io/example/code")
df <- read.csv("../../data_all.csv")
df$state <- as.numeric(df$state)
df$GEOID <- as.numeric(df$GEOID)
df$year <- as.numeric(df$year)
df$prcp <- df$prcp * 1000
df$prcp2 <- df$prcp**2
df$year2 <- df$year**2
mod <- felm(log_yield ~ gdd + egdd + prcp + prcp2 | factor(state) : poly(year,2) + factor(GEOID) | 0 | state, data=df)
summary(mod)
# Merge
df = merge(gmfd, usda)
df <- filter(df, year <= 2005) # Select east of 100W meridian
df1 <- read.csv("../../data_all.csv")
df1$state <- as.numeric(df$state)
df1$GEOID <- as.numeric(df$GEOID)
df1$year <- as.numeric(df$year)
df1$prcp <- df$prcp * 1000
df1$prcp2 <- df$prcp**2
df1$year2 <- df$year**2
mod <- felm(log_yield ~ gdd + egdd + prcp + prcp2 | factor(state) : poly(year,2) + factor(GEOID) | 0 | state, data=df1)
summary(mod)
View(df1)
df1 <- read.csv("../../data_all.csv")
df1$state <- as.numeric(df$state)
df1$GEOID <- as.numeric(df$GEOID)
df1$year <- as.numeric(df$year)
df1$prcp <- df1$prcp * 1000
df1$prcp2 <- df1$prcp**2
df1$year2 <- df1$year**2
mod <- felm(log_yield ~ gdd + egdd + prcp + prcp2 | factor(state) : poly(year,2) + factor(GEOID) | 0 | state, data=df1)
summary(mod)
df <- filter(df, year >= 1960)
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
# Merge
df = merge(gmfd, usda)
df <- filter(df, year <= 2005) # Match GCM period
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
df$year2 <- df$year**2
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + egdd + prcp + prcp2 | state[year,year2] + fips, df)
library(fixest)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + egdd + prcp + prcp2 | state[year,year2] + fips, df)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[year,year2] + fips, df)
summary(fx.mod, cluster=~state)
coefplot(fx.mod)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[[year,year2]] + fips, df)
summary(fx.mod, cluster=~state)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[year,year2] + fips, df)
summary(fx.mod, cluster=~state)
coefplot(fx.mod)
# View results
yhat <- fitted.values(fx.mod)
df$log_yield_pred <- yhat
# Merge
df = merge(gmfd, usda)
df <- filter(df, year <= 2005) # Match GCM period
df$year2 <- df$year**2
coef(fx.mod)
coefplot(fx.mod)
coef(fx.mod)
setwd("~/Projects/UIUC/ClimagAll/BCSD_CornYields_UQ/code")
############################################################################
############### Apply yield regression to climate data
############################################################################
model <- read.csv('../data/climate/NEX-GDDP/agvar_historical_r1i1p1_ACCESS1-0.csv')
View(model)
############################################################################
############### Apply yield regression to climate data
############################################################################
climod <- read.csv('../data/climate/NEX-GDDP/agvar_historical_r1i1p1_ACCESS1-0.csv')
climmod$prcp <- climmod$prcp * 1000 # m to mm
climmodd$prcp2 <- climmod$prcp**2
climod$prcp <- climod$prcp * 1000 # m to mm
climodd$prcp2 <- climod$prcp**2
############################################################################
############### Apply yield regression to climate data
############################################################################
climod <- read.csv('../data/climate/NEX-GDDP/agvar_historical_r1i1p1_ACCESS1-0.csv')
climod$prcp <- climod$prcp * 1000 # m to mm
climodd$prcp2 <- climod$prcp**2
climod$prcp2 <- climod$prcp**2
View(climod)
climod$yield <- predict(fx.mod, climod)
############################################################################
############### Apply yield regression to climate data
############################################################################
climod <- read.csv('../data/climate/NEX-GDDP/agvar_historical_r1i1p1_ACCESS1-0.csv')
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$yield <- predict(fx.mod, climod)
climod$yield <- predict(fx.mod, climod)
climod$year2 <- climod$year**2
climod$yield <- predict(fx.mod, climod)
View(climod)
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
############################################################################
############### Apply yield regression to climate data
############################################################################
nex.models <- list.files('../data/climate/NEX-GDDP/')
print(name)
for(name in nex.models) {
print(name)
}
############################################################################
############### Apply yield regression to climate data
############################################################################
nex.models <- list.files('../data/climate/NEX-GDDP/hist/')
paste('../data/climate/NEX-GDDP/hist', 'test', sep="/")
substr('../data/climate/NEX-GDDP/hist', 0, 2)
substr('../data/climate/NEX-GDDP/hist', 2, -1)
substr('../data/climate/NEX-GDDP/hist', 0, 2) <- ""
substr('../data/climate/NEX-GDDP/hist', 0, 2) <- " "
substr('../data/climate/NEX-GDDP/hist', 0, 2) <- "aa"
substr(x, 0, 2) <- "aa"
x <- '../data/climate/NEX-GDDP/hist'
substr(x, 0, 2)
substr(x, 0, len(x))
substr(x, 0, nchar(x))
substr(x, 4, nchar(x))
############################################################################
############### Apply yield regression to climate data
############################################################################
nex.path <- '../data/climate/NEX-GDDP/hist/'
nex.models <- list.files(nex.path)
paste("all", substr(x, 5, nchar(x)), sep="")
############################################################################
############### Apply yield regression to climate data
############################################################################
nex.path <- '../data/climate/NEX-GDDP/hist/'
nex.models <- list.files(nex.path)
for(name in nex.models) {
climod <- read.csv(paste(nex.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
out.name <- paste("all", substr(name, 5, nchar(name)), sep="")
write.csv(climod, paste(nex.path, out.name, sep="/"))
}
View(climod)
View(climod)
############################################################################
############### Apply yield regression to climate data
############################################################################
nex.path <- '../data/climate/NEX-GDDP/hist'
nex.models <- list.files(nex.path)
for(name in nex.models) {
climod <- read.csv(paste(nex.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod <- subset(climod, select = -c('year2', 'prcp2') )
nex.out.path <- '../data/yield/NEX-GDDP/hist'
out.name <- paste("all", substr(name, 6, nchar(name)), sep="_")
write.csv(climod, paste(nex.path, out.name, sep="/"))
}
climod <- subset(climod, select = -c(year2, prcp2) )
View(climod)
for(name in nex.models) {
climod <- read.csv(paste(nex.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod <- subset(climod, select = -c(year2, prcp2) )
nex.out.path <- '../data/yield/NEX-GDDP/hist'
out.name <- paste("all", substr(name, 6, nchar(name)), sep="_")
write.csv(climod, paste(nex.path, out.name, sep="/"))
}
library(dplyr)
library(lfe)
library(fixest)
library(ggplot2)
######################################
############### Fit yield model
######################################
# Load climate data
gmfd <- read.csv('../data/climate/GMFD/agvar_historical_gmfd.csv')
gmfd$prcp <- gmfd$prcp * 1000 # m to mm
gmfd$prcp2 <- gmfd$prcp**2
# Load yield data
usda <- read.csv('../data/usda/maize_county_yield_area.csv')
usda <- subset(usda, select=c('fips','year','lat','lon','log_yield', 'state'))
usda <- filter(usda, lon >= -100) # Select east of 100W meridian
# Merge
df = merge(gmfd, usda)
df <- filter(df, year <= 2005) # Match GCM period
df$year2 <- df$year**2
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[year,year2] + fips, df)
summary(fx.mod, cluster=~state)
coefplot(fx.mod)
coef(fx.mod)
############################################################################
############### Apply yield regression to climate data
############################################################################
nex.path <- '../data/climate/NEX-GDDP/hist'
nex.models <- list.files(nex.path)
climod <- read.csv(paste(nex.path, name, sep="/"))
name <- nex.models[1]
climod <- read.csv(paste(nex.path, name, sep="/"))
View(climod)
paste(nex.path, name, sep="/")
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
View(climod)
climod <- subset(climod, select = -c(year2, prcp2) )
nex.out.path <- '../data/yield/NEX-GDDP/hist'
out.name <- paste("all", substr(name, 6, nchar(name)), sep="_")
out.name
out.name <- paste("all", substr(name, 7, nchar(name)), sep="_")
out.name
paste(nex.path, out.name, sep="/")
paste(nex.out.path, out.name, sep="/")
View(climod)
nex.models <- list.files(nex.path)
for(name in nex.models) {
climod <- read.csv(paste(nex.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod <- subset(climod, select = -c(year2, prcp2) )
nex.out.path <- '../data/yield/NEX-GDDP/hist'
out.name <- paste("all", substr(name, 7, nchar(name)), sep="_")
write.csv(climod, paste(nex.out.path, out.name, sep="/"))
}
for(name in nex.models) {
climod <- read.csv(paste(nex.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod <- subset(climod, select = -c(year2, prcp2) )
nex.out.path <- '../data/yield/NEX-GDDP/hist'
out.name <- paste("all", substr(name, 7, nchar(name)), sep="_")
write.csv(climod, paste(nex.out.path, out.name, sep="/"), row.names=FALSE)
}
out.name
# CMIP
cmip.path <- '../data/climate/CMIP'
cmip.models <- list.files(cmip.path)
name <- cmip.models[1]
name
substr(name, nchar(name)-20, nchar(name))
substr(name, 1, nchar(name)-10)
substr(name, 1, nchar(name)-30)
substr(name, 1, nchar(name)-25)
substr(name, 1, nchar(name)-23)
substr(name, 1, nchar(name)-20)
substr(name, 1, nchar(name)-21)
name <- substr(name, 1, nchar(name)-21)
substr(name, 5, nchar(name))
substr(name, 7, nchar(name))
# CMIP
cmip.path <- '../data/climate/CMIP'
cmip.models <- list.files(cmip.path)
for(name in cmip.models) {
climod <- read.csv(paste(cmip.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod <- filter(climod, year <= 2005) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod <- subset(climod, select = -c(year2, prcp2) )
cmip.out.path <- '../data/yield/CMIP/hist'
cmip.name <- substr(name, 1, nchar(name)-21)
cmip.name <- substr(cmip.name, 7, nchar(cmip.name))
out.name <- paste("all", name, sep="_")
out.name <- paste(out.name, "historical.csv", sep="_")
write.csv(climod, paste(cmip.out.path, out.name, sep="/"), row.names=FALSE)
}
library(dplyr)
library(lfe)
library(fixest)
library(ggplot2)
######################################
############### Fit yield model
######################################
# Load climate data
gmfd <- read.csv('../data/climate/GMFD/agvar_historical_gmfd.csv')
gmfd$prcp <- gmfd$prcp * 1000 # m to mm
gmfd$prcp2 <- gmfd$prcp**2
# Load yield data
usda <- read.csv('../data/usda/maize_county_yield_area.csv')
usda <- subset(usda, select=c('fips','year','lat','lon','log_yield', 'state'))
usda <- filter(usda, lon >= -100) # Select east of 100W meridian
# Merge
df = merge(gmfd, usda)
df <- filter(df, year <= 2005) # Match GCM period
df$year2 <- df$year**2
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[year,year2] + fips, df)
summary(fx.mod, cluster=~state)
coefplot(fx.mod)
coef(fx.mod)
############################################################################
############### Apply yield regression to climate data
############################################################################
# NEX-GDDP
nex.path <- '../data/climate/NEX-GDDP/hist'
nex.models <- list.files(nex.path)
for(name in nex.models) {
climod <- read.csv(paste(nex.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod <- subset(climod, select = -c(year2, prcp2) )
nex.out.path <- '../data/yield/NEX-GDDP/hist'
out.name <- paste("all", substr(name, 7, nchar(name)), sep="_")
write.csv(climod, paste(nex.out.path, out.name, sep="/"), row.names=FALSE)
}
# CMIP
cmip.path <- '../data/climate/CMIP'
cmip.models <- list.files(cmip.path)
for(name in cmip.models) {
climod <- read.csv(paste(cmip.path, name, sep="/"))
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod <- filter(climod, year <= 2005) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod <- subset(climod, select = -c(year2, prcp2) )
cmip.out.path <- '../data/yield/CMIP/hist'
cmip.name <- substr(name, 1, nchar(name)-21)
cmip.name <- substr(cmip.name, 7, nchar(cmip.name))
out.name <- paste("all", cmip.name, sep="_")
out.name <- paste(out.name, "historical.csv", sep="_")
write.csv(climod, paste(cmip.out.path, out.name, sep="/"), row.names=FALSE)
}
View(gmfd)
View(gmfd)
# Save GMFD values
log_yield_predicted <- fitted.values(fx.mod)
gmfd$log_yield <- log_yield_predicted
df$log_yield_pred <- log_yield_predicted
View(df)
df$log_yield_sim <- log_yield_predicted
write.csv(subset(df, select = c(year, fips, state, gdd, edd, prcp, log_yield_sim)), "../data/yield/GMFD/all_gmfd_historical.csv")
write.csv(subset(df, select = c(year, fips, state, gdd, edd, prcp, log_yield_sim)),
"../data/yield/GMFD/all_gmfd_historical.csv",
row.names=FALSE)
library(dplyr)
library(lfe)
library(fixest)
library(ggplot2)
######################################
############### Fit yield model
######################################
# Load climate data
gmfd <- read.csv('../data/climate/GMFD/agvar_historical_gmfd.csv')
gmfd$prcp <- gmfd$prcp * 1000 # m to mm
gmfd$prcp2 <- gmfd$prcp**2
# Load yield data
usda <- read.csv('../data/usda/maize_county_yield_area.csv')
usda <- subset(usda, select=c('fips','year','lat','lon','log_yield', 'state'))
usda <- filter(usda, lon >= -100) # Select east of 100W meridian
# Merge
df = merge(gmfd, usda)
df <- filter(df, year <= 2005) # Match GCM period
df$year2 <- df$year**2
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[year,year2] + fips, df)
summary(fx.mod, cluster=~state)
coefplot(fx.mod)
coef(fx.mod)
write.csv(coef(fx.mod), "../data/yield/regression_coeffs+se.csv")
coefint(fx.mod)
confint(fx.mod, cluster=~state)
coef(fx.mod)
confint(fx.mod, cluster=~state)
data.frame(confint(fx.mod, cluster=~state))
data.frame(coef(fx.mod), confint(fx.mod, cluster=~state))
res <- data.frame(c('coeff','2.5','97.5'), coef(fx.mod), confint(fx.mod, cluster=~state), row.names=1)
res <- data.frame(coef(fx.mod), confint(fx.mod, cluster=~state))
colnames(res) <- c('coeff','2.5','97.5'),
write.csv(coef(fx.mod), "../data/yield/regression_coeffs+se.csv")
colnames(res) <- c('coeff','2.5','97.5')
res
write.csv(res, "../data/yield/regression_coeffs+95.csv")
res <- data.frame(coef(fx.mod), confint(fx.mod, cluster=~state))
colnames(res) <- c('var', 'coeff','2.5','97.5')
colnames(res) <- c('coeff','2.5','97.5')
write.csv(res, "../data/yield/regression_coeffs+95.csv")
fixef(fx.mod)
fixef(fx.mod)[0]
fixef(fx.mod)['fips']
fixef(fx.mod)$fips
write.csv(fixef(fx.mod)$fips, "../data/yield/regression_fips_fe.csv")
fe.res <- data.frame(fixef(fx.mod)$fips)
colnames(fe.res) <- c('fe')
View(fe.res)
write.csv(fe.res, "../data/yield/regression_fips_fe.csv")
plot(fixef(fx.mod))
nex.path <- '../data/climate/NEX-GDDP/hist'
nex.models <- list.files(nex.path)
climod <- read.csv(paste(nex.path, nex.models[2], sep="/"))
View(climod)
climod$prcp <- climod$prcp * 1000 # m to mm
climod$prcp2 <- climod$prcp**2
# climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
climod$year2 <- climod$year**2
climod <- filter(climod, year >= 1956) # Match GCM period
climod$yield <- predict(fx.mod, climod)
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(fips) : poly(year,2) + factor(fips) | 0 | state, data=df)
library(dplyr)
library(lfe)
library(fixest)
library(ggplot2)
######################################
############### Fit yield model
######################################
# Load climate data
gmfd <- read.csv('../data/climate/GMFD/agvar_historical_gmfd.csv')
gmfd$prcp <- gmfd$prcp * 1000 # m to mm
gmfd$prcp2 <- gmfd$prcp**2
# Load yield data
usda <- read.csv('../data/usda/maize_county_yield_area.csv')
usda <- subset(usda, select=c('fips','year','lat','lon','log_yield', 'state'))
usda <- filter(usda, lon >= -100) # Select east of 100W meridian
# Merge
df = merge(gmfd, usda)
df <- filter(df, year <= 2005) # Match GCM period
df$year2 <- df$year**2
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(fips) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[year,year2] + fips, df)
summary(fx.mod, cluster=~state)
# Fit model using felm
mod <- felm(log_yield ~ gdd + edd + prcp + prcp2 | factor(state) : poly(year,2) + factor(fips) | 0 | state, data=df)
summary(mod)
# Fit model using fixest (easier for getting predictions)
fx.mod <- feols(log_yield ~ gdd + edd + prcp + prcp2 | state[year,year2] + fips, df)
summary(fx.mod, cluster=~state)
# Results
coefplot(fx.mod)
fixef(fx.mod)
